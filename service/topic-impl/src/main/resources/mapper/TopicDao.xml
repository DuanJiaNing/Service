<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duan.service.dao.TopicDao">

    <sql id="allFields">id, user_id, app_id, `status`, title, notes, insert_time</sql>

    <select id="findAll" resultType="com.duan.service.entity.Topic">
        SELECT
        <include refid="allFields"/>
        FROM topic
    </select>

    <select id="find" resultType="com.duan.service.entity.Topic"
            parameterType="com.duan.service.entity.Topic">
        SELECT
        <include refid="allFields"/>
        FROM topic
        <where>
            <if test="id != null">
                AND id=#{id}
            </if>
            <if test="userId != null">
                AND user_id=#{userId}
            </if>
            <if test="appId != null">
                AND app_id=#{appId}
            </if>
            <if test="status != null">
                AND `status`=#{status}
            </if>
            <if test="title != null and title.length() > 0">
                AND title like '%${title}%'
            </if>
            <if test="notes != null">
                AND notes=#{notes}
            </if>
            <if test="insertTime != null">
                AND insert_time=#{insertTime}
            </if>
        </where>
        ORDER BY insert_time desc
    </select>

    <select id="findByTitle" resultType="com.duan.service.entity.Topic">
        SELECT
        <include refid="allFields"/>
        FROM topic WHERE `title`=#{value}
    </select>

<!--    TODO-->
    <select id="findSummaryByIds" resultType="com.duan.service.dto.TopicSummaryDTO">
        SELECT
vc.topic_id AS topic_id,
case when vc.vote > 0 then
FROM (
(SELECT uvc.topic_id AS topic_id, SUM(uvc.vote) AS vote FROM user_vote_comment uvc WHERE uvc.topic_id IN (22,23,24,25) GROUP BY uvc.topic_id) vc
LEFT JOIN
(SELECT uit.topic_id AS topic_id, COUNT(uit.user_id) AS interestUserCount FROM user_interest_topic uit GROUP BY uit.topic_id) it
ON vc.topic_id = it.topic_id)

#GROUP BY topic_id
    </select>

    <insert id="insert" parameterType="com.duan.service.entity.Topic" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO topic (`status`, app_id, user_id, title, notes)
            VALUE (#{status}, #{appId}, #{userId}, #{title}, #{notes})
    </insert>

</mapper>